<!DOCTYPE html>
<html>
    
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <title>Brisbane Floods - A Timeline</title>
        <script type='text/javascript' src='http://code.jquery.com/jquery-1.8.3.js'></script>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
        <script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/infobox/src/infobox.js"></script>
        <!--<script type='text/javascript' src='js/search.js'></script>
        debugging is a nightmare, because chrome doesn't properly reload external js file-->
        <link rel="stylesheet" type="text/css" href="base.css">
        <!-- <link rel="stylesheet" type="text/css" href="http://necolas.github.io/normalize.css/2.1.3/normalize.css"> -->
        <!-- <link rel="stylesheet" type="text/css" href="/css/result-light.css"> -->
        <style type='text/css'>
            @import url('http://twitter.github.com/bootstrap/assets/css/bootstrap.css');
        </style>

<script type="text/javascript">
    
//global vars 
var apiKey = "71lcag6a17k5r6a7";          
var map, geocoder;
var photoInfoBox;
var prevSearchTerm, prevMinYear, prevMaxYear, prevPageA, prevPageP;

//map marker management - global
google.maps.Map.prototype.markers = new Array();

google.maps.Map.prototype.getMarkers = function () {
    return this.markers
};

google.maps.Map.prototype.clearMarkers = function () {
    for (var i = 0; i < this.markers.length; i++) {
        this.markers[i].setMap(null);
    }
    this.markers = new Array();
};

google.maps.Marker.prototype._setMap = google.maps.Marker.prototype.setMap;

google.maps.Marker.prototype.setMap = function (map) {
    if (map) {
        map.markers[map.markers.length] = this;
    }
    this._setMap(map);
}


$(window).load(function () {

    //Set up functions to call when buttons and timeline is clicked
    //Timeline
    $("#tm1893").on("click", function() { newSearch(1893); return false; });
    $("#tm1931").on("click", function() { newSearch(1931); return false; });
    $("#tm1974").on("click", function() { newSearch(1974); return false; });
    $("#tm2011").on("click", function() { newSearch(2011); return false; });
    $("#tm2013").on("click", function() { newSearch(2013); return false; });

    $("#f_toggle").on("click", function() { toggleDiv("#filters"); return false; });
    $("#a_load").on("click", function() { searchArticles(prevSearchTerm, prevMinYear, prevMaxYear); return false; });
    $("#p_load").on("click", function() { searchPictures(prevSearchTerm, prevMinYear, prevMaxYear); return false; });

    //Hide advanced options
    toggleDiv("#filters");


    //Start google map
    geocoder = new google.maps.Geocoder();

    var latlng = new google.maps.LatLng(-27.471011, 153.023449);
    var settings = {
        zoom: 12,
        center: latlng,
        mapTypeControl: true,
        mapTypeControlOptions: {
            style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
        },
        navigationControl: true,
        navigationControlOptions: {
            style: google.maps.NavigationControlStyle.SMALL
        },
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    map = new google.maps.Map(document.getElementById("map_canvas"), settings);


    // action that occurs when the 'Search' button is clicked
    //$("#searchbtn").bind("click", function() {
});


function newSearch(searchYear, searchTerm, minYear, maxYear) {

    //Only searchTerm is required

    //Do a new search, clear existing results

    //default value for searchTerm is "brisbane floods"
    searchTerm = (typeof searchTerm === "undefined") ? "brisbane floods" : "brisbane floods" + searchTerm;

    //if searchYear is -2, minYear and maxYear have manually been passed
    if (searchYear != -2) {
        minYear = searchYear - 1; //give some leeway for years
        maxYear = searchYear + 2;
    }

    //set history
    prevSearchTerm = searchTerm;
    prevMinYear = minYear;
    prevMaxYear = maxYear;
    prevPageA = 0;
    prevPageP = 0;

    //clear existing results
    $('#articles').empty();
    map.clearMarkers();
    if (photoInfoBox) photoInfoBox.close();

    //search
    searchArticles(searchTerm, minYear, maxYear);
    searchPictures(searchTerm, minYear, maxYear);
}


function searchArticles(searchTerm, minYear, maxYear) {

    //Perform article search

    var searchZone = "newspaper";
    var maxArticles = 30;

    var articleURL = "http://api.trove.nla.gov.au/result?key=" + apiKey + "&encoding=json&zone=" 
        + searchZone + "&sortby=relevance&n=" + maxArticles + "&q=" + searchTerm + " date:[" + minYear + " TO " + maxYear + "]&s=" + prevPageA + "&callback=?";

    prevPageA += maxArticles;

    //Query Trove, process each article returned
    $.getJSON(articleURL, function (data) {

        if (data.response.zone[0].records.article) {
            $.each(data.response.zone[0].records.article, processArticle);
        }
    });
}


function searchPictures(searchTerm, minYear, maxYear) {

    //Perform picture search

    var searchZone = "picture";
    var maxPictures = 100;

    var pictureURL = "http://api.trove.nla.gov.au/result?key=" + apiKey + "&include=workversions&encoding=json&zone=" 
        + searchZone + "&sortby=relevance&n=" + maxPictures + "&q=" + searchTerm + " date:[" + minYear + " TO " + maxYear + "]&s=" + prevPageP + "&callback=?";    

    prevPageP += maxPictures;

    //Query Trove, process each picture returned
    $.getJSON(pictureURL, function (data) {

        if (data.response.zone[0].records.work) {
            $.each(data.response.zone[0].records.work, processPicture);
        }
    });
}


function processArticle(index, item) {

    var text = "<p><h3>" + item.heading + "</h3>" + "<h4><a href='"
        + item.troveUrl + "' target='_blank'>" + item.title.value 
        + "</a></h4>" + item.snippet + "</p><hr width='40%' align='center'/>"

    $('#articles').append(text);
    console.log("article +")
}


function processPicture(index, item) {

    //First get the location, then define infobox content and place marker

    //Try to get lat/long coords from location tag
    if (typeof item.version[0].record[0] === 'object') {
        if (typeof item.version[0].record[0].metadata === 'object') {
            if (typeof item.version[0].record[0].metadata.dc === 'object') {
                if (typeof item.version[0].record[0].metadata.dc.coverage === 'string') {
                    var loc = item.version[0].record[0].metadata.dc.coverage;
                }
            }
        }
    }

    //If location tag exists
    if (typeof loc !== 'undefined') {

        //check if it contains lat/long
        var point = loc.match(/-?\d+\.\d+/g);

        if (typeof point !== 'undefined') {

            var lat = parseFloat(point[0]);
            var lng = parseFloat(point[1]);

            var markerPos = new google.maps.LatLng(lat, lng);

            //Successful in finding lat/long, so place a marker
            placeMarker(markerPos, item.title, setInfoBoxContent(item, loc));
            console.log("picture +")
            return;
        }
    }

    //If not successful in getting lat/long, geocode the picture's title
    //codeAddress(item);
    console.log("geocoding");
    
}


function codeAddress(item) {
    
    geocoder.geocode( { 'address': item.title + ', Australia'}, function(results, status) {
        
        if (status == google.maps.GeocoderStatus.OK) {
            
            //map.setCenter(results[0].geometry.location);
            var loc = results[0].geometry.location;
            placeMarker(loc, item.title, setInfoBoxContent(item, "      "));
            
        } else {
          alert('Geocode was not successful for the following reason: ' + status);
        }

    });
}


function setInfoBoxContent(item, loc) {

    //Set the marker infobox content

    //check if thumbnail exists, and if so get URL
    var thumburl;
    for (var i = 0; i < item.identifier.length; i++) {
        if (typeof item.identifier[i].linktype === 'string') {
            if (item.identifier[i].linktype == 'thumbnail') {
                thumburl = item.identifier[i].value;
            }
        }
    }

    //photo description
    var snippet = "";
    if (typeof item.snippet === 'string') snippet = item.snippet;

    //infobox HTML
    var info = "<div class='mapinfobox'><p><a href='" + item.identifier[0].value 
        + "' target='_blank'><img src='" + thumburl + "' alt='blah'></a><a href='" 
        + item.troveUrl + "' target='_blank'>" + item.title + "</a><br />" 
        + loc.replace(/-?\d+\.\d+/g, '').slice(0,-3) + "<br /></p><p>" + snippet + "</p></div>";

    return info;
}


function placeMarker(markerPos, title, info) {

    //Place a marker on the map after location and content has been determined

    //Create marker
    var marker = new google.maps.Marker({
        position: markerPos,
        map: map,
        title: title
    });

    //Set up the infobox
    google.maps.event.addListener(marker, 'click', function () {

        //close existing infobox
        if (photoInfoBox) photoInfoBox.close();

        //create the infobox
        photoInfoBox = new InfoBox({
            content: info,
            maxWidth: 150,
            pixelOffset: new google.maps.Size(-140, 0),
            zIndex: null,
            boxStyle: {
                background: "url('http://google-maps-utility-library-v3.googlecode.com/svn/trunk/infobox/examples/tipbox.gif') no-repeat",
                opacity: 0.95
            },
            closeBoxMargin: "12px 4px 2px 2px",
        });

        photoInfoBox.open(map, marker);
    });
}


function toggleDiv(div) {
    $(div).toggle();
}


</script>


    </head>
    
    <body>
        <div class="container">
            <div id="header">
                    <h1>Brisbane Floods - A Timeline</h1>

            </div>
            <div id="searchinput">
                <div id="timeline">
                    <img class="img-center" src="img/timeline.jpg" alt="" usemap="#map1378997951168">
                    <map id="map1378997951168" name="map1378997951168">
                        <area shape="rect" coords="109,27,156,72" title="1983" alt="1893" href="#" id="tm1893">
                        <area shape="rect" coords="329,28,389,75" title="1931" alt="1931" href="#" id="tm1931">
                        <area shape="rect" coords="504,31,543,75" title="1974" alt="1974" href="#" id="tm1974">
                        <area shape="rect" coords="751,30,786,74" title="2011" alt="2011" href="#" id="tm2011">
                        <area shape="rect" coords="789,28,825,73" title="2013" alt="2013" href="#" id="tm2013">
                    </map>
                </div>

                <a id="f_toggle" href="#">Advanced search</a>
                <div id="filters" class="img-center">

                    <div id="f_same">
                        <input id="f_usesame" type="checkbox">Use the same filters for Articles and Photos
                        <button id="f_submit">Search</button>
                    </div>
                    
                    <div id="f_labels">
                        <ul>
                            <li>Date range</li>
                            <li>Suburb/place</li>
                            <li>Additional keywords</li>
                        </ul>
                    </div>
                    <div id="f_articles">
                        <p>Articles</p>
                        <input id="fa_minYear" class="f_year" type="text"> to 
                        <input id="fa_maxYear" class="f_year" type="text">
                        <input id="fa_area" type="text">
                        <input id="fa_keywords" type="text">
                    </div>
                    <div id="f_photos">
                        <p>Photos</p>
                        <input id="fp_minYear" class="f_year" type="text"> to 
                        <input id="fp_maxYear" class="f_year" type="text">
                        <input id="fp_area" type="text">
                        <input id="fp_keywords" type="text">
                    </div>

                </div>
            </div>

            <div id="leftside">
                <div id="articles"></div>
            </div>
            <div id="rightside">
                <div id="map_canvas"></div>
                <a id="a_load" href="#">See more articles</a> &nbsp;&nbsp; | &nbsp;&nbsp;
                <a id="p_load" href="#"> Load more photos</a>
            </div>
            <div id="footer">
                <!-- Powered by Trove -->
                <a href="http://trove.nla.gov.au/" target="_blank" class="fl-right"><img alt="Powered by Trove" src="http://trove.nla.gov.au/general-test/files/2012/01/API-light.png"></a>
            </div>
        </div>
    </body>

</html>